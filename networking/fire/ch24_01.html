<html>
<!-- Mirrored from nnc3.com/mags/Networking2/fire/ch24_01.htm by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 28 Jul 2017 17:50:13 GMT -->
<head><title>Two Sample Firewalls (Building Internet Firewalls, 2nd Edition)</title><link rel="stylesheet" type="text/css" href="../style/style1.css" />

<meta name="DC.Creator" content="Elizabeth D. Zwicky, Simon Cooper and D. Brent Chapman" /><meta name="DC.Format" content="text/xml" scheme="MIME" /><meta name="DC.Language" content="en-US" /><meta name="DC.Publisher" content="O'Reilly &amp; Associates, Inc." /><meta name="DC.Source" scheme="ISBN" content="1565928717L" /><meta name="DC.Subject.Keyword" content="stuff" /><meta name="DC.Title" content="Building Internet Firewalls, 2nd Edition" /><meta name="DC.Type" content="Text.Monograph" />

</head><body bgcolor="#ffffff">

<img alt="Book Home" border="0" src="gifs/smbanner.gif" usemap="#banner-map" /><map name="banner-map"><area shape="rect" coords="1,-2,616,66" href="index-2.html" alt="Building Internet Firewalls" /><area shape="rect" coords="629,-11,726,25" href="jobjects/fsearch.html" alt="Search this book" /></map>

<div class="navbar"><table width="684" border="0"><tr><td align="left" valign="top" width="228"><a href="ch23_02.html"><img alt="Previous" border="0" src="../gifs/txtpreva.gif" /></a></td><td align="center" valign="top" width="228"></td><td align="right" valign="top" width="228"><a href="ch24_02.html"><img alt="Next" border="0" src="../gifs/txtnexta.gif" /></a></td></tr></table><div>




<h1 class="chapter">Chapter 24. Two Sample Firewalls</h1>
<div class="htmltoc"><h4 class="tochead">Contents:</h4>
      <a href="#ch24-16832">Screened Subnet Architecture</a><br />
<a href="ch24_02.html">Merged Routers and Bastion Host Using General-Purpose Hardware</a><br /></p><p></div>

<a name="INDEX-2176" /></a>In this chapter, we describe
two sample configurations for basic firewalls. Almost any real
firewall is going to be more complex than those described in this
chapter, but this presentation should give you some idea of the tasks
involved in building a firewall and how the various pieces fit
together.</p><p>


<a name="ch24-2-fm2xml" /></a><blockquote><b>TIP:</b> 
We want to emphasize that these examples are just that: examples. You
shouldn't blindly implement one of these examples without first
taking the time to understand your own needs, your environment, and
the implications and complications of the services you want your
firewall to provide.</p><p>

</blockquote>

The services that we're going to provide through these sample
firewalls are just the basics: the World Wide Web, terminal access,
file transfer, electronic mail, Usenet news, and DNS.</p><p>


<div class="sect1"><a name="ch24-16832" /></a>
<h2 class="sect1">24.1. Screened Subnet Architecture</h2>


<a name="INDEX-2177" /></a><a name="INDEX-2178" /></a>The screened subnet architecture,
described in <a href="ch06_01.html">Chapter 6, "Firewall Architectures"</a>, and shown in <a href="ch24_01.html#ch24-20734">Figure 24-1</a>, is probably the most common do-it-yourself
firewall architecture. This architecture provides good security
(including multiple layers of redundancy) at what most sites feel is
a reasonable cost.</p><p>


<a name="ch24-20734" /></a><div class="figure"><img alt="Figure 24-1" src="figs/fire2.2401.gif" /></div><h4 class="objtitle">Figure 24-1. Screened subnet architecture </h4>

There are two-router and single-router variations of the screened
subnet architecture. Basically, you can use either a pair of
two-interface routers or a single three-interface router. The
single-router screened subnet architecture works about as well as the
two-router screened subnet architecture and is often somewhat
cheaper. However, you need to use a router that can handle both
inbound and outbound packet filtering on each interface. (See the
discussion of this point in <a href="ch08_01.html">Chapter 8, "Packet Filtering"</a>.) We're
going to use a two-router architecture as our example in this section
because it is conceptually simpler.</p><p>


This type of firewall includes the following components, presented
originally in <a href="ch06_01.html">Chapter 6, "Firewall Architectures"</a>:</p><p>


<dl>
<dt><i>Perimeter network</i></dt>
<dd><a name="INDEX-2179" /></a>Isolates
your bastion host from your internal network, so a security breach on
the bastion host won't immediately affect your internal
network.</p><p></dd>


<dt><i>Exterior router</i></dt>
<dd><a name="INDEX-2180" /></a>Connects
your site to the outside world. If possible, the exterior router also
provides at least some protection for the bastion host, interior
router, and internal network. (This isn't always possible
because some sites use exterior routers that are managed by their
network service providers and are therefore beyond the site's
control.)</p><p></dd>


<dt><i>Interior router</i></dt>
<dd><a name="INDEX-2181" /></a>Protects
the internal network from the world and from the site's own
bastion host.</p><p></dd>


<dt><i>Bastion host</i></dt>
<dd><a name="INDEX-2182" /></a>Serves as the
site's main point of contact with the outside world. (It should
be set up according to the guidelines in <a href="ch10_01.html">Chapter 10, "Bastion Hosts"</a>.)</p><p></dd>

</dl>


In addition to the machines that make up the firewall itself, assume
there are machines on the internal network (internal hosts) that
fulfill the following roles (note that any given internal machine
might fill any, or even all, of these roles):</p><p>


<ul><li>Mail server</p><p></li><li>Usenet news server<p></p></li><li><p>DNS server</p></li><li><p>Client for various Internet services</p></li></ul>
Each of these internal services is provided directly (via packet
filtering) or indirectly (via proxy servers running on the bastion
host).</p><p>


We're going to assume (at least for the purposes of this
example) that internal users in our system are trusted not to
actively try to circumvent the firewall, and that there is no
particular need to monitor or log their Internet activities.</p><p>


We're also going to assume that you are using properly assigned
and routed IP addresses (that is, addresses assigned to your site and
properly routed and advertised to the rest of the Internet by your
service provider) for your internal and perimeter networks. If you
aren't, you have to use proxies or network address translation
because you can't allow packets with those unassigned IP
addresses onto the Internet; even if you did allow them, replies
would have no way to come back to you.</p><p>


Finally, we're going to assume you're using separate
network numbers for your perimeter net and internal net, so that you
can detect forged packets easily. (See the discussion in <a href="ch08_06.html#ch08-5294">Section 8.6.1, "Risks of Filtering by Source Address"</a> in <a href="ch08_01.html">Chapter 8, "Packet Filtering"</a>.)</p><p>


<a name="ch24-16898" /></a><div class="sect2">
<h3 class="sect2">24.1.1. Service Configuration</h3>


Given the architecture we've just described, how do we provide
the basic Internet services?</p><p>


<a name="ch24-3-fm2xml" /></a><div class="sect3">
<h3 class="sect3">24.1.1.1. HTTP and HTTPS</h3>


We will want to provide two kinds of HTTP service. We'll want
to allow our users to access other people's web sites, and
we'll want to put up our own web site.</p><p>


<a name="INDEX-2183" /></a> <a name="INDEX-2184" /></a><a name="INDEX-2185" /></a>For outgoing HTTP and HTTPS
(letting our users access other sites), we can use either packet
filtering or proxy servers. Packet filtering will allow our users to
access HTTP and HTTPS servers only on standard ports; proxying will
allow them to reach all HTTP and HTTPS servers. Which approach should
we take?</p><p>


Standard browsers support HTTP and HTTPS proxying, so we don't
need to worry about using customized clients with either approach.
Proxying will increase configuration overhead, but that price seems
fair for the increased abilities it offers.</p><p>


On the other hand, we could simply allow internal hosts to create
connections to port 80, port 443, and any port at or above 1024. That
will allow access to almost any HTTP or HTTPS server and will also be
useful for supporting FTP. It does add a significant amount of risk;
internal users will be able to use any protocol above 1024, with no
control from the firewall. If these users are ill intentioned or even
careless, they could expose the site to all sorts of dangers. In
addition, any Trojan horse programs they bring in will easily be able
to send out data. However, we originally chose to trust the users, so
this is not an issue. Using pure packet filtering this way would lose
us only servers at nonstandard ports below 1024, and those ports are
all supposed to be reserved anyway.</p><p>


If we use a caching proxy server, we significantly improve HTTP
performance for all of the following:</p><p>


<dl>
<dt><i>HTTP clients</i></dt>
<dd>They obtain pages from the cache over the internal network, rather
than from the original server over our Internet connection, which is
probably much slower.</p><p></dd>


<dt><i>Non-HTTP clients</i></dt>
<dd>The HTTP clients won't be using so much of the bandwidth of our
Internet connection, leaving more of it for other clients to use.</p><p></dd>


<dt><i>HTTP servers at other sites</i></dt>
<dd>They will get only one request from our site for a given page, rather
than multiple requests.</p><p></dd>

</dl>


HTTPS connections can't be cached because the encryption means
that pages are different every time they're accessed, but a
caching proxy server won't interfere with HTTPS service; it
will simply act like a normal proxy.</p><p>


ost caching servers will also allow us to provide HTTP service to
external sites, so we can take advantage of that to publish our
site's own public web pages. This configuration is not
particularly secure; the security requirements for proxying and
publishing are different, and ideally we would want to separate the
two. However, in a configuration with only one bastion host, we
can't provide much separation in any case.</p><p>


Combining the proxying and publishing wouldn't be acceptable if
we wanted to provide popular pages, or if we needed much security for
the pages we were providing (for instance, if the web pages are used
for electronic commerce). In either of those situations, we'd
separate the outgoing cache from the public web server, putting them
not only on different pieces of software but also on different
computers. In fact, we might well choose to have the public web
server on somebody else's network altogether, using a
commercial web hosting service.</p><p>


<a name="INDEX-2186" /></a><a name="INDEX-2187" /></a>HTTP and HTTPS proxying is also
trivial to add once you have other things proxied via SOCKS or TIS
FWTK. If we had SOCKS running, it would be very tempting to simply
proxy through it because SOCKS is one of the systems that many of the
browsers support. On the other hand, it's a lot of trouble to
install SOCKS just for HTTP and HTTPS; it's probably not worth
it unless we have other applications that will use it. If we used the
TIS FWTK HTTP proxy, we'd have to get the users to modify URLs
they use. In this case, the users wouldn't be able to cut and
paste out of their electronic mail when people tell them about cool
new things. Neither SOCKS nor TIS FWTK makes an attractive option in
this situation.</p><p>


However, both proxying (through a proxying server) and packet
filtering appear to be attractive and reasonable choices. Proxying is
definitely preferable if we aren't going to provide
passive-mode FTP directly (which gives our users the ability to talk
to servers on any TCP port above 1023). On the other hand, packet
filtering would definitely be preferable if we wanted to use clients
that didn't come with built-in support for proxying, or if we
wanted not to provide an HTTP server and had no other services being
proxied.</p><p>


For this example, we're going to assume that we're
providing HTTP and HTTPS service to internal clients via a proxy
server running on the bastion host, and that we're using the
same server to publish our public web pages to the world. We will
take special care to make sure that the proxy component is configured
to prevent external users from using the proxy to access either our
internal network or other external servers. Our reasons for using a
proxy server are based mostly on the added efficiency, although
it's also useful to make sure that users can reach HTTP and
HTTPS servers on nonstandard ports below 1023.<a name="INDEX-2188" /></a><a name="INDEX-2189" /></a></p><p>
</div>



<a name="ch24-16901" /></a><div class="sect3">
<h3 class="sect3">24.1.1.2. SMTP</h3>


<a name="INDEX-2190" /></a><a name="INDEX-2191" /></a>There aren't many options
for SMTP in any configuration. We want all external SMTP connections
to go to a single machine with a secured SMTP server, and we
don't trust random internal machines to have safe SMTP servers.
That means we'll put a secured SMTP server on the bastion host
and use DNS MX records to direct all incoming mail to the bastion
host, which will then pass all the incoming mail to a single secured
internal SMTP server.</p><p>


What other options do we have? We could put a secure SMTP server on
the internal mail server and direct incoming mail to it, but if that
SMTP server were compromised, the entire internal net would then be
at risk. Alternatively, we could have the bastion host send mail
directly to machines on the internal network, but once again,
we'd be increasing our vulnerability if the SMTP server on the
bastion host were compromised. The compromised bastion host would be
speaking to untrustworthy internal SMTP servers, and compromise of
the internal net would quickly follow. If the bastion host can speak
only to the internal mail server, that narrows the possible attacks
it can make; the internal mail server can run a secured SMTP server.
Furthermore, by making this choice, messy maintenance tasks are
transferred from the security-critical bastion host to the less
vulnerable internal mail server.</p><p>


How about outgoing mail? It would probably be safe to allow internal
machines to send mail directly to the outside world, but doing so
creates a maintenance headache. (You have to watch the mail
configuration on all the internal machines.) Besides, doing this
opens another direct connection between the internal and external
networks. There aren't any known ways for an SMTP server to
attack an SMTP client, but stranger things have happened.</p><p>


Allowing internal machines to send mail directly to the outside world
doesn't seem to bring much advantage either. The only
difference it makes is that we'd be able to send mail (but not
receive it) when the bastion host is down.</p><p>


No matter what decision we make, we'll have to configure our
mail clients. (Unlike FTP and Telnet, SMTP does not work as installed
without modifying configuration files.) In addition, the work to
direct the mail to a server is less than the work to correctly send
it to the external universe.</p><p>


The only real question is whether to direct the outgoing mail from
the internal machines to the internal mail server or to the bastion
host. Directing it to the internal mail server has the same
advantages as for incoming mail and keeps internal information away
from the bastion host. Mail between internal users should not go
through the bastion host.</p><p>


We'll set up SMTP, as outlined in <a href="ch16_01.html">Chapter 16, "Electronic Mail and News"</a>,
with the bastion host acting as a middleman for incoming and outgoing
mail. Here's what to do:</p><p>


<ul><li>Publish DNS MX records that direct incoming mail for the site to the
bastion host.</p><p></li><li>Configure internal machines to send all outgoing mail to the internal
mail server.</p><p></li><li>Configure the bastion host to send all incoming mail to a single
internal mail server and to send outgoing mail directly to its
destination.</p><p></li></ul>
For this example, we're going to assume that there is a single
internal mail server for incoming and outgoing mail.<a name="INDEX-2192" /></a></p><p>
</div>



<a name="ch24-4-fm2xml" /></a><div class="sect3">
<h3 class="sect3">24.1.1.3. Telnet</h3>


<a name="INDEX-2193" /></a><a name="INDEX-2194" /></a>Outgoing
Telnet could be provided through packet filtering or through proxies.
Which approach should we use?</p><p>


Proxying will require either modified clients or modified user
procedures; either one will be tedious to implement. Proxying would
allow us to restrict or monitor Telnet usage by user by forcing our
users to authenticate to a proxy server before completing their
requests. However, remember that we have decided to assume that
internal users are trustworthy, so there is no need for
authentication. Proxying would be necessary if we were using
unassigned or unadvertised IP addresses internally, but that's
not the case here either. Because we have trustworthy users and
proper IP addresses, proxying for Telnet doesn't provide any
advantage over packet filtering, and it's more difficult to set
up and maintain. Therefore, for this example, we're going to
provide outgoing Telnet via packet filtering.</p><p>


Incoming Telnet is considerably more difficult to provide safely and
conveniently. If it were necessary, incoming Telnet could be provided
on the bastion host using extra authentication. However, for a site
that is looking for a simple configuration, the reasonable thing to
do is to disallow incoming Telnet altogether, replacing it with SSH.
That's what we'll do for this example.</p><p>
</div>



<a name="ch24-5-fm2xml" /></a><div class="sect3">
<h3 class="sect3">24.1.1.4. SSH</h3>


<a name="INDEX-2195" /></a><a name="INDEX-2196" /></a>Although
incoming Telnet is unsafe, it's useful to be able to allow some
form of remote access. The safest way to do so is to allow SSH. One
way would be to allow SSH inbound to the bastion host only, forcing
users to log into the bastion host and then go from there to their
internal destination; this is effectively a form of proxying. Another
option would be to allow SSH inbound to any host.</p><p>


Forcing SSH to a single bastion host allows us to make sure that
what's coming in is genuinely SSH and that the SSH server is
safely configured. On the other hand, it requires us to have user
accounts configured on the bastion host. If only a few users need to
use SSH, it may be the best way to provide the service. However, with
only a single bastion host, significant risks are involved in having
user accounts around.</p><p>


Allowing SSH inbound to all hosts avoids the problem with user
accounts on the bastion host but opens up the possibility of having
hosts running SSH servers that will do port forwarding, or running
other servers altogether on the SSH port. As we discuss in <a href="ch18_01.html">Chapter 18, "Remote Access to Hosts"</a>, port forwarding across SSH is a significant
risk, which may make your site vulnerable to people who are attacking
the client. We will allow SSH inbound to all hosts (we're
already trusting internal users).</p><p>


For a more secure configuration, we would limit the hosts that were
accessible via SSH, either by adding another bastion host on the
screened network or by treating some internal hosts as screened hosts
and allowing SSH to just those hosts.</p><p>


Since we are allowing incoming SSH, we should also allow outgoing
SSH; it would be unjust to ask people to use SSH to access our site
but require our users to use insecure Telnet to access other sites.
However, we will want to warn our users about the risks of remote
port forwarding. Unlike outgoing Telnet, outgoing SSH opens us up to
incoming attacks if port forwarding is turned on. (See <a href="ch18_01.html">Chapter 18, "Remote Access to Hosts"</a>, for more information about the risks of SSH
port forwarding.) For more security, we might want to limit even
outgoing SSH to a machine where we could control the clients in use
and disallow remote port forwarding. Note that even when SSH is
limited to a single machine, it is significantly difficult to prevent
users from providing their own SSH clients.</p><p>
</div>



<a name="ch24-16916" /></a><div class="sect3">
<h3 class="sect3">24.1.1.5. FTP</h3>


<a name="INDEX-2197" /></a><a name="INDEX-2198" /></a>Unlike Telnet,
FTP doesn't lend itself to a pure packet filtering solution.
Because normal-mode FTP requires an incoming connection to an
arbitrary port over 1023, trying to allow it without doing anything
else gives attackers access to all kinds of services running on our
internal systems. That leaves us two choices:</p><p>


<ul><li>Support passive mode via packet filtering</p><p></li><li>Support normal mode via proxies<p></p></li></ul>
In either case, the standard FTP clients shipped with Unix operating
systems, and most of the popular, publicly available clients for
personal computers, won't work the normal way. If we use the
TIS FWTK <em class="emphasis">ftp-gw</em> proxy gateway (described in
<a href="ch09_01.html">Chapter 9, "Proxy Systems"</a>), we can use unmodified clients, but at
the cost of teaching the users to follow special procedures. Some
popular FTP clients  --  the ones built in to Web browsers like
Netscape Navigator or Internet Explorer  --  do use passive mode
without being modified, but then again, not all servers support it
well.</p><p>


A reasonable compromise would be to use both packet filtering and
proxies, using a proxying gateway like <em class="emphasis">ftp-gw</em>
from TIS FWTK that doesn't require modification of the clients.
Clients that support passive mode will work via the packet filters.
On platforms where we can easily replace the provided clients, we can
provide passive-mode clients; on platforms where we can't
easily replace the clients, we can modify user procedures instead.</p><p>


As we've said, if we wanted to monitor FTP usage, we'd
have to use proxying exclusively, but that's not the case here.
If we were using an unassigned or unrouted network number, we'd
have to do either proxying or network address translation. We also
might want to use proxying exclusively if we decided to hide DNS data
 --  it would save us the trouble of faking data for
double-reverse lookups by using a published address with an
advertised reverse mapping  --  but hiding DNS data is more
trouble than it's worth. In a situation where proxying is used
exclusively, we'd have to reconsider which proxy server to use.
The proxy server we've selected requires users to modify their
procedures, which makes sense in the configuration we're
discussing because there are no other options. The balance might come
out differently if everybody were proxying.</p><p>


<a name="INDEX-2199" /></a><a name="INDEX-2200" /></a>Be aware that in order to use the TIS
FWTK <em class="emphasis">ftp-gw</em> proxy server on your bastion host,
your packet filtering will have to allow TCP connections from ports
above 1023 on your bastion host to ports above 1023 on internal
hosts, and from port 20 on external hosts to ports above 1023 on your
bastion host, for FTP data channels. (See the discussion of FTP in
<a href="ch17_01.html">Chapter 17, "File Transfer, File Sharing, and Printing"</a>.) This means that someone who breaks in
to the bastion host could easily connect to any server on any
internal host that uses a TCP port above 1023 (for example, an X11
server on port 6000). Further, any servers that are using such ports
(that is, TCP ports above 1023) on the bastion host itself are also
vulnerable. For this reason, if you allow these FTP data connections
at all for proxying, you probably want to explicitly block access to
internal systems to TCP ports above 1023 where you know, or have good
cause to suspect, that servers might be listening. At the very least,
the ports you want to block probably include 6000 through around 6003
(assuming four or fewer real or virtual X11 servers per machine; see
the discussion of X11 in <a href="ch18_01.html">Chapter 18, "Remote Access to Hosts"</a>). Since
we're allowing SSH, we also need to protect the virtual X11
servers that SSH creates, which start at 6010, so we'll extend
this port range to 6020.</p><p>


Keep in mind, however, that blocking specific ports, rather than
blocking all ports by default and then allowing specific ports, is
generally a dangerous strategy. It's hard to develop and
maintain a complete list of ports that need to be blocked at your
site. It would be better to block everything by default and then
allow only specific ports, but you can't do that with standard
(nonpassive) FTP because of the way it works.</p><p>


Allowing passive-mode FTP with packet filtering is a fairly liberal
approach because it allows pretty much any connection to go through
as long as it is initiated by the inside. The number of servers above
port 1023 is very large. This has some advantages (it lets users
access nonstandard HTTP servers, for example), but it may also allow
users to access all kinds of services that are unsafe. In allowing
it, we're assuming that our users are not only well
intentioned, they're also capable of telling the difference
between a safe and an unsafe connection, or at least avoiding the
temptation to do unexpected things.</p><p>


Because we've denied incoming Telnet, it makes sense to deny
incoming user FTP as well. Both services require approximately the
same security measures, and making one of them available would make
configuring the other trivial.</p><p>


Incoming anonymous FTP is a different matter, and we'll provide
it. Because we're not a major Internet service provider, and
because we're using TIS FWTK already anyway, we can go for
security over features and use the TIS FWTK anonymous FTP server. If
we were going to provide major anonymous FTP, we'd probably
want to use the more feature-filled <em class="emphasis">wuarchive</em>
FTP server (see <a href="ch17_01.html">Chapter 17, "File Transfer, File Sharing, and Printing"</a>, for a description of its
capabilities) and run it on a machine that was not the main bastion
host but that was still a bastion host on the perimeter network.
Using another bastion host avoids overloading the main bastion host
with risky and interacting services.</p><p>
</div>



<a name="ch24-16982" /></a><div class="sect3">
<h3 class="sect3">24.1.1.6. NNTP</h3>


<a name="INDEX-2201" /></a><a name="INDEX-2202" /></a>As we've discussed in <a href="ch16_01.html">Chapter 16, "Electronic Mail and News"</a>, the most practical way to set up NNTP across a
firewall is to allow your NNTP service provider(s) to talk directly
to your internal Usenet news host, and vice versa. We'd need an
overwhelming reason to do something else, and it's hard to
imagine one. Even if we didn't have an existing internal news
host, building one isn't any harder than building a news server
on the bastion host, and it's safer by a vast margin. News
servers fail with dreary regularity; while the problems usually
aren't security-related, you still don't want to install
anything requiring high maintenance on a bastion host.</p><p>


For this example, we're going to assume a single external NNTP
newsfeed.</p><p>
</div>



<a name="ch24-17046" /></a><div class="sect3">
<h3 class="sect3">24.1.1.7. DNS</h3>


<a name="INDEX-2203" /></a><a name="INDEX-2204" /></a>As discussed in <a href="ch20_01.html">Chapter 20, "Naming and Directory Services"</a>, DNS is best provided across a firewall with a
pair of servers: one on the bastion host, the other on an internal
host. Like NNTP, DNS presents a situation in which the number of
rational solutions is clearly limited. We need to decide whether to
use separate internal and external servers to do information hiding,
or whether we should allow the external world to see all of our host
data. By deciding to allow direct passive-mode FTP, we've
already made that decision indirectly. Direct passive-mode FTP would
require intricate DNS setup to support information hiding and still
provide valid data for the internal hosts that are FTP clients.</p><p>


For this example, we're going to assume that the DNS server on
the bastion host is a secondary server for our domain, and that the
primary server is on an internal host. We're not going to do
any DNS information hiding.</p><p>
</div>
</div>







<a name="ch24-17147" /></a><div class="sect2">
<h3 class="sect2">24.1.2. Packet Filtering Rules</h3>

<a name="INDEX-2205" /></a>Based on the configuration
decisions we've made in the previous sections, let's look
at the packet filtering rules necessary to support this
configuration. We assume an "ideal" router (as discussed
in "Choosing a Packet Filtering Router" in <a href="ch08_01.html#ch08-4014">{XREF}</a>). If our router were less than ideal in terms
of capabilities, we'd need to modify these rules accordingly,
probably at the cost of security. We might have to rethink several
crucial decisions entirely. For example, if we couldn't filter
on the ACK bit, direct outbound passive-mode FTP would no longer be
acceptably safe, and a lot of our other decisions have used that as a
major factor. (See <a href="ch08_01.html">Chapter 8, "Packet Filtering"</a> for a full discussion
of packet filtering capabilities and the implications of not having
particular capabilities.)
</p><p>

In the packet filtering rules presented in the following table, we
assume that the filtering system:
</p><p>

<ul><li>
Can distinguish between incoming and outgoing packets</p><p>
</li><li>
Can filter on source address, destination address, packet type (TCP
or UDP), source port, and destination port
</p><p>
</li><li>
Can filter on whether or not the ACK bit is set (for TCP packets)</p><p>
</li><li>
Applies rules in the order listed</p><p>
</li></ul>
<a name="ch24-6-fm2xml" /></a><blockquote><b>TIP:</b> 
In the following table, directions are shown relative to the site, as
they have been in previous tables.
</p><p>
</blockquote>

<a name="ch24-17171" /></a><div class="sect3">
<h3 class="sect3">24.1.2.1. Interior router</h3>

<a name="INDEX-2206" /></a><a name="INDEX-2207" /></a>The purpose of the interior router is
to protect the internal network from the Internet and from your own
bastion host. The interior router needs the following rules to
support the outlined configuration. Explanations of each rule follow
the table.
</p><p>

<a name="ch24-7-fm2xml" /></a><table border="1">










<tr>
<th>
Rule</p><p>
</th>
<th>
Dir.</p><p>
</th>
<th>
SourceAddress</p><p>
</th>
<th>
Dest.Address</p><p>
</th>
<th>
Protocol</p><p>
</th>
<th>
SourcePort</p><p>
</th>
<th>
Dest.Port</p><p>
</th>
<th>
ACKSet</p><p>
</th>
<th>
Action</p><p>
</th>
</tr>


<tr>
<td>
Spoof-1</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Internal</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Deny</p><p>
</td>
</tr>
<tr>
<td>
Spoof-2</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
External</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Deny</p><p>
</td>
</tr>
<tr>
<td>
HTTP-1</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Internal</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
80</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
HTTP-2</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
Internal</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
80</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Yes</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
Telnet-1</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Internal</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
23</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
Telnet-2</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Internal</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
23</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Yes</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
SSH-1</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Internal</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
22</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
SSH-2</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Internal</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
22</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Yes</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
SSH-3</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Internal</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
22</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
SSH-4</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Internal</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
22</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Yes</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
FTP-1</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Internal</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
21</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
FTP-2</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Internal</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
21</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Yes</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
FTP-3</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Internal</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
FTP-4</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Internal</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Yes</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
FTP-5</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Internal</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
21</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
FTP-6</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
Internal</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
21</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Yes</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
FTP-7</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
Internal</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
6000-6020</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Deny</p><p>
</td>
</tr>
<tr>
<td>
FTP-8</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
Internal</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
FTP-9</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Internal</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Yes</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
SMTP-1</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Internal SMTP server</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
25</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
SMTP-2</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
Internal SMTP server</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
25</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Yes</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
SMTP-3</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
Internal SMTP server</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
25</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
SMTP-4</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Internal SMTP server</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
25</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Yes</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
NNTP-1</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Internal NNTP server</p><p>
</td>
<td>
NNTP feed server</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
119</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
NNTP-2</p><p>
</td>
<td>
In</p><p>
</td>
<td>
NNTP feed server</p><p>
</td>
<td>
Internal NNTP server</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
119</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Yes</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
NNTP-3</p><p>
</td>
<td>
In</p><p>
</td>
<td>
NNTP feed server</p><p>
</td>
<td>
Internal NNTP server</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
119</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
NNTP-4</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Internal NNTP server</p><p>
</td>
<td>
NNTP feed server</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
119</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Yes</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
DNS-1</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Internal DNS server</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
UDP</p><p>
</td>
<td>
53</p><p>
</td>
<td>
53</p><p>
</td>
<td>
<a href="#FOOTNOTE-180">[180]</a></p><p>

</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
DNS-2</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
Internal DNS server</p><p>
</td>
<td>
UDP</p><p>
</td>
<td>
53</p><p>
</td>
<td>
53</p><p>
</td>
<td>
<a href="#FOOTNOTE-180">[180]</a>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
DNS-3</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Internal DNS server</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
53</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
DNS-4</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
Internal DNS server</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
53</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Yes</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
DNS-5</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
Internal DNS server</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
53</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
DNS-6</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Internal DNS server</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
53</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Yes</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
Default-1</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Deny</p><p>
</td>
</tr>
<tr>
<td>
Default-2</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Deny</p><p>
</td>
</tr>

</table><p>
<a name="FOOTNOTE-180" /></a>[180]UDP has no ACK equivalent.</p><p>


Here is some additional information about each set of rules in this
table:
</p><p>

<dl>
<dt><i>Spoof-1 and Spoof-2</i></dt>
<dd>
Spoof-1 blocks incoming packets that claim to come from internal IP
addresses (that is, forged packets presumably sent by an attacker).
Spoof-2 blocks outgoing packets that claim to come from external IP
addresses (these reflect either bad misconfiguration of machines or
an attacker's operating inside your network). Spoof-2 may be
difficult to implement on some packet filtering systems because it
can be easily written only if you can use negation on source
addresses (to specify addresses that are not in the internal range).
It would be acceptable to omit it in this situation; it is mostly
there to protect other people, not to protect your site.
</p><p>
</dd><dt><i>HTTP-1 and HTTP-2</i></dt>
<dd>
Allow internal HTTP clients to connect to the HTTP proxy server on
your bastion host. Clients can use their HTTP connection to the proxy
server to request services with any protocol the proxy server will
support; the connection from the client to the proxy server will be
over port 80, while the connection from the proxy server to the
destination server will be over the appropriate port for the desired
protocol. Therefore, these rules will support HTTPS as well as HTTP.
</p><p>
</dd><dt><i>Telnet-1 and Telnet-2</i></dt>
<dd>
Allow outgoing Telnet connections.</p><p>
</dd><dt><i>SSH-1 and SSH-2</i></dt>
<dd>
Allow outgoing SSH connections. We have the client port set to
"Any" (instead of "&gt;1023" like most of the
other protocols) because some forms of authentication require SSH
clients to use ports at or below 1023.
</p><p>
</dd><dt><i>SSH-3 and SSH-4</i></dt>
<dd>
Allow incoming SSH connections. We have the client port set to
"Any" (instead of "&gt;1023" like most of the
other protocols) because some forms of authentication require SSH
clients to use ports at or below 1023.
</p><p>
</dd><dt><i>FTP-1 and FTP-2</i></dt>
<dd>
Allow outgoing command-channel connections to FTP servers, for use by
passive-mode internal clients that are interacting with those servers
directly.
</p><p>
</dd><dt><i>FTP-3 and FTP-4</i></dt>
<dd>
Allow the FTP data channel connections from passive-mode internal
clients to external FTP servers. Note that these rules actually allow
all connections from internal TCP ports above 1023 to external TCP
ports above 1023. That may be more than you want to allow, but
there's no way to cover passive-mode FTP with anything less
broad, and connections are at least restricted to those opened from
the inside.
</p><p>
</dd><dt><i>FTP-5 and FTP-6</i></dt>
<dd>
Allow normal (nonpassive-mode) internal FTP clients to open an FTP
command channel to the proxy FTP server on the bastion host. Note
that these rules are actually redundant if you have rules FTP-1 and
FTP-2 in place earlier in the list because "Bastion" as a
source or destination (covered by rules FTP-5 and FTP-6) is a subset
of "All" (covered by rules FTP-1 and FTP-2). Having these
redundant rules is going to impose a slight performance cost but
makes the rule set easier to understand. It also makes it possible to
change rules FTP-1 and FTP-2 (e.g., if you decide you don't
want to support passive-mode clients) without accidentally breaking
normal-mode client access to the proxy server.
</p><p>
</dd><dt><i>FTP-7 through FTP-9</i></dt>
<dd>
Allow FTP data connections from the proxy server on the bastion host
to nonpassive internal clients. The FTP-7 rule prevents an attacker
who has gained access to the bastion host from attacking internal X11
servers via the hole created by rules FTP-8 and FTP-9. If you have
other servers internally listening for connections on TCP ports above
1023, you should add similar rules for them. Note that trying to list
things that should be denied (as in rule FTP-7) is generally a losing
proposition because your list will almost always be incomplete
somehow (e.g., because you overlooked or didn't know about some
internal service, or because the service was added after the filters
were established). However, it's the best you can do in this
situation to support normal-mode FTP clients.
</p><p>
</dd><dt><i>SMTP-1 and SMTP-2</i></dt>
<dd>
Allow outgoing mail from your internal mail server to the bastion
host.
</p><p>
</dd><dt><i>SMTP-3 and SMTP-4</i></dt>
<dd>
Allow incoming mail from the bastion host to your internal mail
server.
</p><p>
</dd><dt><i>NNTP-1 and NNTP-2</i></dt>
<dd>
Allow outgoing Usenet news from your news server to your service
provider's news server.
</p><p>
</dd><dt><i>NNTP-3 and NNTP-4</i></dt>
<dd>
Allow incoming Usenet news from your service provider's news
server to your news server.
</p><p>
</dd><dt><i>DNS-1</i></dt>
<dd>
Allow UDP-based DNS queries and answers from the internal DNS server
to the bastion host DNS server.
</p><p>
</dd><dt><i>DNS-2</i></dt>
<dd>
Allow UDP-based DNS queries and answers from the bastion host DNS
server to the internal DNS server.
</p><p>
</dd><dt><i>DNS-3 and DNS-4</i></dt>
<dd>
Allow TCP-based DNS queries from the internal DNS server to the
bastion host DNS servers, as well as answers to those queries. Also
allow zone transfers in which the bastion host DNS server is the
primary server and the internal DNS server is the secondary server.
</p><p>
</dd><dt><i>DNS-5 and DNS-6</i></dt>
<dd>
Allow TCP-based DNS queries from the bastion host DNS server to the
internal DNS server, as well as answers to those queries. Also allow
zone transfers in which the bastion host DNS server is the secondary
server and the internal DNS server is the primary server.
</p><p>
</dd><dt><i>Default-1 and Default-2</i></dt>
<dd>
Block all packets not specifically allowed by one of the preceding
rules.
</p><p>
</dd>

</dl>

How you translate these abstract rules into specific rules for your
particular filtering system depends on the syntax used by your
system. Some systems allow you to enter the rules as a single table,
much as we show here in this table. Other systems require you to
specify rules for incoming and outgoing packets in separate rule
sets. Splitting these rules between incoming and outgoing packets is
not a problem, as long as you preserve the order for rules of each
type; that is, as long as all the incoming rules stay in the same
order relative to each other, and all the outgoing rules stay in the
same order relative to each other.<a name="INDEX-2208" /></a><a name="INDEX-2209" /></a>
</p><p>

</div>

<a name="ch24-18003" /></a><div class="sect3">
<h3 class="sect3">24.1.2.2. Exterior router</h3>

<a name="INDEX-2210" /></a><a name="INDEX-2211" /></a>The purpose of the exterior router is
twofold:
</p><p>

<ul><li>
To connect the perimeter net (and thus your site) to the outside world</p><p>
</li><li>
To protect the perimeter net and the internal net against the outside
world
</p><p>
</li></ul>
In many circumstances, only the former purpose is possible because
the exterior router is often provided and managed by your network
service provider. That provider may be unable or unwilling to set up
and maintain packet filtering rules on the exterior router (and
unable or unwilling to let you do it yourself).
</p><p>

The differences between the rules for the interior router and the
exterior router all have to do with the bastion host. That's
because the bastion host sits "outside" of the interior
router (i.e., on the side of the interior router towards the
Internet), but it sits "inside" of the exterior router
(i.e., on the side of the exterior router away from the Internet).
</p><p>

If you can set up filtering on the exterior router, it's a good
idea to do so. If nothing else, it can serve as a backup to some of
the filtering on the interior router. For this example, you would
need to establish the following rules.
</p><p>

<a name="ch24-8-fm2xml" /></a><table border="1">










<tr>
<th>
Rule</p><p>
</th>
<th>
Dir.</p><p>
</th>
<th>
SourceAddress</p><p>
</th>
<th>
Dest.Address</p><p>
</th>
<th>
Protocol</p><p>
</th>
<th>
SourcePort</p><p>
</th>
<th>
Dest.Port</p><p>
</th>
<th>
ACKSet</p><p>
</th>
<th>
Action</p><p>
</th>
</tr>


<tr>
<td>
Spoof-1</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Internal </p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Deny</p><p>
</td>
</tr>
<tr>
<td>
Spoof-2</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Perim.</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Deny</p><p>
</td>
</tr>
<tr>
<td>
Spoof-3</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
External</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Deny</p><p>
</td>
</tr>
<tr>
<td>
HTTP-1</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
HTTP-2</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Yes</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
HTTP-3</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
80</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
HTTP-4</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
80</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Yes</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
Telnet-1</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Internal</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
23</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
Telnet-2</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Internal</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
23</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Yes</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
SSH-1</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Internal</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
22</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
SSH-2</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Internal</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
22</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Yes</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
SSH-3</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Internal</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
22</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
SSH-4</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Internal</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
22</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Yes</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
FTP-1</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Internal</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
21</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
FTP-2</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Internal</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
21</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Yes</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
FTP-3</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Internal</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
FTP-4</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Internal</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Yes</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
FTP-5</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
21</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
FTP-6</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
21</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Yes</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
FTP-7</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
6000-6020</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Deny</p><p>
</td>
</tr>
<tr>
<td>
FTP-8</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
20</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
FTP-9</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
20</p><p>
</td>
<td>
Yes</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
FTP-10</p><p>
</td>
<td>
In </p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
21</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
FTP-11</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
21</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Yes</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
FTP-12</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
20</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
FTP-13</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
20</p><p>
</td>
<td>
Yes</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
FTP-14</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
FTP-15</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
SMTP-1</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
25</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
SMTP-2</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
25</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Yes</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
SMTP-3</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
25</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
SMTP-4</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
25</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Yes</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
NNTP-1</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Internal NNTP server</p><p>
</td>
<td>
NNTP feed server</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
119</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
NNTP-2</p><p>
</td>
<td>
In</p><p>
</td>
<td>
NNTP feed server</p><p>
</td>
<td>
Internal NNTP server</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
119</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Yes</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
NNTP-3</p><p>
</td>
<td>
In</p><p>
</td>
<td>
NNTP feed server</p><p>
</td>
<td>
Internal NNTP server</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
119</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
NNTP-4</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Internal NNTP server</p><p>
</td>
<td>
NNTP feed server</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
119</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Yes</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>

<tr>
<td>
DNS-1</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
UDP</p><p>
</td>
<td>
53</p><p>
</td>
<td>
53</p><p>
</td>
<td>
<a href="#FOOTNOTE-181">[181]</a></p><p>

</td>
<td>
Permit</p><p>
</td>
</tr>

<tr>
<td>
DNS-2</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
UDP</p><p>
</td>
<td>
53</p><p>
</td>
<td>
53</p><p>
</td>
<td>
<a href="#FOOTNOTE-181">[181]</a>
</td>
<td>
Permit</p><p>
</td>
</tr>

<tr>
<td>
DNS-3</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
UDP</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
53</p><p>
</td>
<td>
<a href="#FOOTNOTE-181">[181]</a>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
DNS-4</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
UDP</p><p>
</td>
<td>
53</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
<a href="#FOOTNOTE-181">[181]</a>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
DNS-5</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
53</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
DNS-6</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
53</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Yes</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
DNS-7</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
53</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
DNS-8</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Bastion</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
TCP</p><p>
</td>
<td>
53</p><p>
</td>
<td>
&gt;1023</p><p>
</td>
<td>
Yes</p><p>
</td>
<td>
Permit</p><p>
</td>
</tr>
<tr>
<td>
Default-1</p><p>
</td>
<td>
Out</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Deny</p><p>
</td>
</tr>
<tr>
<td>
Default-2</p><p>
</td>
<td>
In</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Any</p><p>
</td>
<td>
Deny</p><p>
</td>
</tr>

</table><p>
<a name="FOOTNOTE-181" /></a>[181]UDP has no ACK equivalent.</p><p>


Here is some additional information about each set of rules in this
table:
</p><p>

<dl>
<dt><i>Spoof-1 and Spoof-2</i></dt>
<dd>
Block incoming packets that claim to have internal or perimeter net
source IP addresses  --  that is, forged packets presumably sent
by an attacker. Rule Spoof-1 is the same as the Spoof-1 rule on the
interior router; rule Spoof-2 is unique to the exterior router.
</p><p>
</dd><dt><i>Spoof-3</i></dt>
<dd>
Block outgoing packets that claim to have external source IP
addresses. These are either forged packets from an attacker on your
network or symptoms of bad network misconfigurations. Spoof-3 may be
difficult to implement on some packet filtering systems because it
can be easily written only if you can use negation on source
addresses (to specify addresses that are not in the internal range).
It would be acceptable to omit it in this situation; it is mostly
there to protect other people, not to protect your site.
</p><p>
</dd><dt><i>HTTP-1 and HTTP-2</i></dt>
<dd>
Allow the bastion host HTTP proxy server to connect to the HTTP and
HTTPS servers on any machine on the Internet. Actually, these rules
allow any TCP client program on the bastion host using a port above
1023 to contact any server program on any host on the Internet using
any port. This is done so that the HTTP proxy server can contact HTTP
servers on nonstandard port numbers (i.e., other than port 80). As
broad as these rules are, it's important that they allow only
outgoing connections, by examining the ACK bit.
</p><p>
</dd><dt><i>HTTP-3 and HTTP-4</i></dt>
<dd>
Allow external clients to contact the bastion host HTTP server. There
are no equivalent rules on the interior router because no HTTP
servers are on the internal network that external clients can access.
</p><p>
</dd><dt><i>Telnet-1 and Telnet-2</i></dt>
<dd>
Allow outgoing Telnet connections. These are identical to the
corresponding rules on the interior router (as are all rules on the
exterior router that involve internal and external hosts but nothing
on the perimeter net).
</p><p>
</dd><dt><i>SSH-1 and SSH-2</i></dt>
<dd>
Allow outgoing SSH connections. We have the client port set to
"Any" (instead of "&gt;1023" like most of the
other protocols) because some forms of authentication require SSH
clients to use ports at or below 1023. These are the same as the
corresponding rules on the interior router.
</p><p>
</dd><dt><i>SSH-3 and SSH-4</i></dt>
<dd>
Allow incoming SSH connections. We have the client port set to
"Any" (instead of "&gt;1023" like most of the
other protocols) because some forms of authentication require SSH
clients to use ports at or below 1023. These are the same as the
corresponding rules on the interior router. If there is a need to
allow administrators to reach the bastion host with SSH for remote
administration, we will need to add another pair of rules. As it is,
administrators can use SSH to an internal host and then connect from
there to the bastion host, but this is somewhat fragile (if the
interior router is down, there will be no way to administer anything
remotely).
</p><p>
</dd><dt><i>FTP-1 through FTP-4</i></dt>
<dd>
Allow outgoing passive-mode FTP connections and are identical to the
corresponding rules on the interior router.
</p><p>
</dd><dt><i>FTP-5 and FTP-6</i></dt>
<dd>
Allow the FTP proxy server on the bastion host to open an FTP command
channel to FTP servers on the Internet. Note that, unlike the
corresponding rules on the interior router, these rules are
<em class="emphasis">not </em> redundant if you have rules FTP-1 and FTP-2
in place earlier in the list. Why? Because "Bastion" as a
source or destination (covered by rules FTP-5 and FTP-6) is not a
subset of "Internal" (covered by rules FTP-1 and FTP-2).
</p><p>
</dd><dt><i>FTP-7 through FTP-9</i></dt>
<dd>
Allow FTP data connections from external FTP servers to the proxy
server on the bastion host. The FTP-7 rule prevents an attacker from
attacking X11 servers on the bastion host via the hole created by
rules FTP-8 and FTP-9. If other servers on the bastion host are
listening for connections on TCP ports above 1023, you should add
similar rules for them. Note that trying to list things that should
be denied (as in rule FTP-7) is a losing proposition because your
list will almost always be incomplete (e.g., because you overlooked
or didn't know about some service or because the service was
added after the filters were established). However, it's the
best you can do in this situation if you must support normal-mode
FTP.
</p><p>
</dd><dt><i>FTP-10 through FTP-15</i></dt>
<dd>
Allow passive- and normal-mode FTP from external clients to the
anonymous FTP server on the bastion host. There are no equivalent
rules on the internal router because no FTP servers are on the
internal network that external clients can access.
</p><p>
</dd><dt><i>SMTP-1 and SMTP-2</i></dt>
<dd>
Allow outgoing mail from the bastion host to the outside world.</p><p>
</dd><dt><i>SMTP-3 and SMTP-4</i></dt>
<dd>
Allow incoming mail from the outside world to the bastion host.</p><p>
</dd><dt><i>NNTP-1 to NNTP-4</i></dt>
<dd>
Allow Usenet news both ways between your Usenet news server and your
service provider's news server. These rules are identical to
the corresponding rules on the interior router.
</p><p>
</dd><dt><i>DNS-1</i></dt>
<dd>
Allows UDP-based DNS queries and answers from the bastion host DNS
server to DNS servers in the outside world.
</p><p>
</dd><dt><i>DNS-2</i></dt>
<dd>
Allows UDP-based DNS queries and answers from Internet DNS servers to
the bastion host DNS server. Note that rule DNS-2 (which allows
server-to-server communication) is redundant if rule DNS-3 (which
allows client-to-server communication) is present.
</p><p>
</dd><dt><i>DNS-3 and DNS-4</i></dt>
<dd>
Allow external UDP-based DNS clients to query the DNS server on the
bastion host and it to answer them.
</p><p>
</dd><dt><i>DNS-5 and DNS-6</i></dt>
<dd>
Allow TCP-based DNS queries from the bastion host to DNS servers on
the Internet, as well as answers to those queries. Also allow zone
transfers in which the bastion host DNS server is the secondary
server and an external DNS server is the primary server.
</p><p>
</dd><dt><i>DNS-7 and DNS-8</i></dt>
<dd>
Allow TCP-based DNS queries from the outside world to the bastion
host DNS server, as well as answers to those queries. Also allow zone
transfers in which the bastion host DNS server is the primary server
and an external DNS server is the secondary server.
</p><p>
</dd><dt><i>Default-1 and Default-2</i></dt>
<dd>
Block all packets not specifically allowed by one of the preceding
rules, just as the corresponding rules do on the interior
router.<a name="INDEX-2212" /></a><a name="INDEX-2213" /></a><a name="INDEX-2214" /></a>
</p><p>
</dd>

</dl>

</div>
</div>


<a name="ch24-19090" /></a><div class="sect2">
<h3 class="sect2">24.1.3. Other Configuration Work</h3>



In addition to setting up the packet filtering rules, we need to do
various other kinds of configuration work, as follows:</p><p>



<dl>
<dt><i>On all of the internal machines</i></dt>
<dd>Configure electronic mail so that outgoing mail gets sent to the
internal mail server. We're also going to need to install
passive-mode FTP clients if they're available. We may want to
install SSH clients and servers, configured to disable port
forwarding.</p><p></dd>



<dt><i>On the internal mail server</i></dt>
<dd>Install a trusted SMTP server.</p><p></dd>



<dt><i>On the internal (primary) name server</i></dt>
<dd>Put in an MX record for every A record, pointing incoming mail to the
bastion host; further MX records may be necessary for the internal
mail server to direct the traffic internally. We also need to
configure the bastion host as a recognized secondary name server, and
remove any TXT or HINFO records we don't want the external
world to see (i.e., pretty much any records the external world could
possibly make any sense of).</p><p></dd>



<dt><i>On the bastion host</i></dt>
<dd>Do all the standard bastion host configuration tasks (removing unused
servers, adding logging, and so on), as discussed in <a href="ch10_01.html">Chapter 10, "Bastion Hosts"</a>. We need to install TIS FWTK and configure FTP
proxying, a trusted SMTP server<em class="emphasis">,</em> and anonymous
FTP service from it. We also need to install the HTTP server and
configure it to do proxying, as well as to serve the HTTP pages we
want to show the outside world.</p><p></dd>

</dl>
</div>








<a name="ch24-19131" /></a><div class="sect2">
<h3 class="sect2">24.1.4. Analysis</h3>



Just how good a firewall is this one we've configured?
Let's consider it in relation to the strategies and principles
discussed in <a href="ch03_01.html">Chapter 3, "Security Strategies"</a>.</p><p>



<a name="ch24-19135" /></a><div class="sect3">
<h3 class="sect3">24.1.4.1. Least privilege</h3>



<a name="INDEX-2215" /></a><a name="INDEX-2216" /></a>The principle of least privilege is
that an object (a program, a person, a router, or whatever) should
have the minimum privileges necessary to perform its assigned task
and no more. A corollary of this principle is that systems should be
configured so they require as little privilege as possible. You can
see this principle in action in several places in this setup. For
example, configuring SMTP so that outgoing mail goes out via the
bastion host (rather than directly to remote systems) is an
application of least privilege because it lets you control more
tightly how internal systems connect to external systems. (In this
case, it makes it unnecessary for internal systems to talk directly
to external systems in order to provide this service.)</p><p>
</div>





<a name="ch24-19144" /></a><div class="sect3">
<h3 class="sect3">24.1.4.2. Defense in depth</h3>



<a name="INDEX-2217" /></a><a name="INDEX-2218" /></a>The principle of defense in depth is
something else that you can see in the setup we've described.
For example, internal hosts are protected from the outside world by
the exterior and interior routers. Similarly, the bastion host is
protected against attack both by its own careful configuration and by
the exterior router.</p><p>



Several times, we've explicitly made decisions to increase the
depth of defense. For example, that's one of the main purposes
of using an internal mail server between the bastion host and the
internal clients. The interior and exterior routers often deny the
same packets. Defense in depth is almost the only reason for having
the interior router deny packets that it supposedly can't
receive (because they've already been denied by the exterior
router).</p><p>
</div>





<a name="ch24-19153" /></a><div class="sect3">
<h3 class="sect3">24.1.4.3. Choke point</h3>



<a name="INDEX-2219" /></a><a name="INDEX-2220" /></a>The principle of a choke point is
clearly applied in our setup because everything between internal
clients and the Internet comes through the perimeter net. Further,
much of it comes through the bastion host via proxies. Only Telnet,
SSH, and FTP are provided in ways that leave them relatively open.
These services could have been better choked by using proxies
everywhere.</p><p>
</div>





<a name="ch24-19162" /></a><div class="sect3">
<h3 class="sect3">24.1.4.4. Weakest link</h3>



<a name="INDEX-2221" /></a><a name="INDEX-2222" /></a>There is no single obvious weak link to
attack in this configuration. Probably the weakest link is the
bastion host, but even a completely compromised bastion host
isn't going to help an attacker much when it comes to attacking
the internal systems; not that many connections are allowed from the
bastion host to internal systems. Some of the weakest links you can
see remaining in this setup include incoming SSH, proxy FTP,
combining a public HTTP server with the outgoing caching proxy
server.</p><p>



Allowing inbound SSH to every host is another candidate for the
weakest link; it is the point where we put the most trust in the
users. Users who choose poor passwords or set up SSH tunnels can
easily undermine the security of the firewall. This could be
strengthened significantly by restricting SSH to a dedicated bastion
host, which could help enforce password and tunneling restrictions.
Users could still connect from that host to internal hosts.</p><p>



The proxy FTP setup we've described would allow an attacker who
has compromised the bastion host to attack servers on ports above
1023 (if there are any) on internal hosts. How can you address this
vulnerability? Obtain and use only passive-mode FTP clients
internally, don't run proxy FTP, and remove the rules allowing
proxy FTP from the filters.</p><p>



Combining incoming and outgoing HTTP service has several drawbacks.
First, the server program itself is more complicated; it is trying to
enforce different restrictions for internal and external users, and
bugs or misconfigurations may inappropriately mix the two, allowing
external users to use the server to attack internal machines or third
parties. Second, public HTTP servers attract attackers, who you do
not want to concentrate on a machine that is important to your site's
functioning. You could address this problem by moving the public HTTP
server to a dedicated machine, or even using an outside web hosting
service to remove it from your site altogether.</p><p>



As discussed in <a href="ch03_01.html">Chapter 3, "Security Strategies"</a>, there are two reasons
for knowing what the weakest links in your firewall are. The first
reason is so that you can fix them, if possible; we've already talked
about things you might change in this firewall to strengthen some of
the weak links. The second reason is so that you can monitor those
links which you cannot eliminate for one reason or another. For
instance, to address the risks posed by allowing SMTP from the
bastion host to the internal mail server, you can't practically
disallow incoming SMTP; that would cut off incoming mail from the
outside world, which probably isn't appropriate. Since you can't
eliminate that weak link, you should instead monitor it closely to
make sure that an attacker doesn't take advantage of it (i.e., you
should monitor the internal mail server for attacks from the bastion
host via SMTP, by monitoring the SMTP logs and reports on the
internal mail server).</p><p>



You can keep playing the game of thinking "If I were an
attacker, what would I do?" and then addressing the problems
you discover ad nauseam, or until you run out of time or money. At
some point, though, you (or your management) will probably decide
you've done enough (based on your own site's definition
of "enough").</p><p>
</div>





<a name="ch24-19184" /></a><div class="sect3">
<h3 class="sect3">24.1.4.5. Fail-safe stance</h3>



<a name="INDEX-2223" /></a><a name="INDEX-2224" /></a>You can see the principle of a
fail-safe stance applied through the packet filtering rules. In
general, the rules specify what you're going to allow and deny
everything else by default. This is a fail-safe approach because if
something unanticipated comes along (a new service, for example), it
won't be allowed through your firewall, unless, of course, it
mimics or is tunneled through some other service you do allow. The
redundant router rules also provide a fail-safe against failure of
one router or the other. If filtering accidentally or temporarily
gets turned off on one router (causing it to pass all packets), the
other still does most of the same filtering, at least as far as the
outside world is concerned.</p><p>
</div>





<a name="ch24-19192" /></a><div class="sect3">
<h3 class="sect3">24.1.4.6. Universal participation</h3>



<a name="INDEX-2225" /></a>
<a name="INDEX-2226" /></a>If this is our site's only
connection to the Internet, we have involuntary universal
participation; everybody has to go through the firewall to get to the
Internet. Of course, we'd be much better off with voluntary
universal participation, but that may require some user education
about the goals of and the need for the security measures we're
adopting.</p><p>



To some extent, we're relying on voluntary universal
participation. We've granted free Telnet, SSH, and FTP access,
and in the process, we've allowed any outbound connection to
ports at or above 1024 (which is plenty of rope for the users to hang
us with). FTP is by no means the only service above 1024.</p><p>



In particular, we've assumed that this is your sole connection
to the Internet and that internal users aren't just going to
bypass the firewall entirely by setting up their own Internet
connections. All it takes is one joker with a modem, a PPP software
package, and an outside phone line, and you too could have an
unprotected back door into your network.</p><p>
</div>





<a name="ch24-19200" /></a><div class="sect3">
<h3 class="sect3">24.1.4.7. Diversity of defense</h3>



<a name="INDEX-2227" /></a>There are opportunities in this
configuration to apply the principle of diversity of defense (e.g.,
using routers from different vendors for the interior and exterior
packet filtering systems). Most sites will probably conclude that
such an approach is not worth the hassle. However, even if you use
similar or identical hardware, you still might get some diversity by
having different people do at least the initial configuration of the
different filtering systems, and then having them cross-check each
other's work.</p><p>



Using different SMTP servers on the internal mail server and the
bastion host would be a fairly major advance in this configuration
because that's one of the main weak points of this setup. Even
a less secure but different SMTP server on the internal mail server
is arguably better than one that's going to yield to the exact
same attack that just succeeded on the bastion host. The more
vulnerable the SMTP server you're using, the more important an
issue this is.</p><p>
</div>





<a name="ch24-9-fm2xml" /></a><div class="sect3">
<h3 class="sect3">24.1.4.8. Simplicity</h3>



Simplicity is another important security strategy. This particular
firewall configuration provides simplicity by separating components
so that each component is as simple and comprehensible as possible.
We've made a number of decisions specifically to simplify the
configuration; for example, the decision to use separate interior and
exterior routers (rather than a single three-interface router)
simplifies the packet filtering rules and makes them easier to
understand.</p><p>
</div>
</div>








<a name="ch24-19210" /></a><div class="sect2">
<h3 class="sect2">24.1.5. Conclusions</h3>



A lot of advantages are offered by a scheme such as the one
we've described in the previous sections. The main potential
disadvantages we can see are cost and complexity; but we don't
think that the configuration we've presented is too expensive
for most sites, and we think that it presents the minimum necessary
level of complexity.</p><p>



What if you really need to save some money? It would be feasible to
construct a screened subnet architecture using a single
three-interface router, instead of the pair of two-interface routers
we've described. The solution would be a little more complex
because you'd have to merge the two separate filtering sets
described previously, but doing so shouldn't be too difficult.</p><p>



It would also be relatively easy to construct a more secure
configuration with the same basic architecture. A less trusting site
would force all Telnet, SSH, and FTP through proxies, which would
allow much better logging and remove the nagging holes created by
allowing every outbound connection to ports above 1024. Once you
force the extra protocols through proxies, you'd also find that
DNS information hiding would be both more practical and more
reasonable. However, the price of this increased security would be a
more complex and fragile configuration, and one that presents more
annoyance to the users.</p><p>



It would also be possible to increase the services offered without
major architecture changes. For example, incoming Telnet and incoming
user FTP could be supported relatively easily for a few users on the
bastion host or on a dedicated host on the screened network. Serious
anonymous FTP service or HTTP service could be provided by
configuring extra machines on the screened network. Similarly, you
could scale up the firewall to support a second Internet connection
or redundant bastion hosts to provide more reliable service or
service for a much larger internal network.<a name="INDEX-2228" /></a><a name="INDEX-2229" /></a></p><p>
</div>
</div>




















<hr width="684" align="left" />
<div class="navbar"><table width="684" border="0"><tr><td align="left" valign="top" width="228"><a href="ch23_02.html"><img alt="Previous" border="0" src="../gifs/txtpreva.gif" /></a></td><td align="center" valign="top" width="228"><a href="index-2.html"><img alt="Home" border="0" src="../gifs/txthome.gif" /></a></td><td align="right" valign="top" width="228"><a href="ch24_02.html"><img alt="Next" border="0" src="../gifs/txtnexta.gif" /></a></td></tr><tr><td align="left" valign="top" width="228">23.2. Games</td><td align="center" valign="top" width="228"><a href="index/index.html"><img alt="Book Index" border="0" src="../gifs/index.gif" /></a></td><td align="right" valign="top" width="228">24.2. Merged Routers and Bastion Host Using General-Purpose Hardware</td></tr></table><div>
<hr width="684" align="left" />

<img alt="Library Navigation Links" border="0" src="../gifs/navbar.gif" usemap="#library-map" />
<p><font size="-1"><a href="copyrght.html">Copyright &copy; 2002</a> O'Reilly &amp; Associates. All rights reserved.</font></p><p>

<map name="library-map"><area shape="rect" coords="1,0,84,90" href="../index.html" /><area shape="rect" coords="86,-7,176,90" href="../ssh/index.html" /><area shape="rect" coords="178,0,265,101" href="../tcp/index.html" /><area shape="rect" coords="266,0,333,90" href="../nfs/index.html" /><area shape="rect" coords="334,-1,429,93" href="../snmp/index.html" /><area shape="rect" coords="431,0,529,116" href="../tshoot/index.html" /><area shape="rect" coords="534,0,594,104" href="../dns/index.html" /><area shape="rect" coords="595,1,704,108" href="index-2.html" /></map>

</div></div></div></div></body>
<!-- Mirrored from nnc3.com/mags/Networking2/fire/ch24_01.htm by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 28 Jul 2017 17:50:13 GMT -->
</html>
<html>
<!-- Mirrored from nnc3.com/mags/Networking2/nfs/ch18_03.htm by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 28 Jul 2017 17:56:44 GMT -->
<head><title>Adjusting for network reliability problems (Managing NFS and NIS, 2nd Edition)</title><link rel="stylesheet" type="text/css" href="../style/style1.css" />

<meta name="DC.Creator" content="Hal Stern, Mike Eisler and Ricardo Labiaga" /><meta name="DC.Format" content="text/xml" scheme="MIME" /><meta name="DC.Language" content="en-US" /><meta name="DC.Publisher" content="O'Reilly &amp; Associates, Inc." /><meta name="DC.Source" scheme="ISBN" content="1565925106L" /><meta name="DC.Subject.Keyword" content="stuff" /><meta name="DC.Title" content="Managing NFS and NIS, 2nd Edition" /><meta name="DC.Type" content="Text.Monograph" />

</head><body bgcolor="#ffffff">

<img alt="Book Home" border="0" src="gifs/smbanner.gif" usemap="#banner-map" /><map name="banner-map"><area shape="rect" coords="1,-2,616,66" href="index.html" alt="Managing NFS &amp; NIS" /><area shape="rect" coords="629,-11,726,25" href="jobjects/fsearch.html" alt="Search this book" /></map>

<div class="navbar"><table width="684" border="0"><tr><td align="left" valign="top" width="228"><a href="ch18_02.html"><img alt="Previous" border="0" src="../gifs/txtpreva.gif" /></a></td><td align="center" valign="top" width="228"><a href="index.html"></a></td><td align="right" valign="top" width="228"><a href="ch18_04.html"><img alt="Next" border="0" src="../gifs/txtnexta.gif" /></a></td></tr></table><div>



<h2 class="sect1">18.3. Adjusting for network reliability problems</h2>

Even a lightly loaded network can suffer from<a name="INDEX-2687" /> reliability problems if older bridges
or routers joining the network segments routinely drop parts of long
packet trains. Older bridges and routers are most likely to affect
NFS performance if their network interfaces cannot keep up with the
packet arrival rates generated by the NFS clients and servers on each
side.
</p>

Some NFS experts believe it is a bad idea to micro-manage NFS to
compensate for network problems, arguing instead that these problems
should be handled by the transport layer. We encourage you to use NFS
over TCP, and allow the TCP implementation to dynamically adapt to
network glitches and unreliable networks. TCP does a much better job
of adjusting transfer sizes, handling congestion, and generating
retransmissions to compensate for network problems.
</p>

Having said this, there may still be times when you choose to use UDP
instead of TCP to handle your NFS traffic.<a href="#FOOTNOTE-57">[57]</a> In such cases, you will need to determine
the impact that an old bridge or router is having on your network.
This requires another look at the client-side RPC statistics:
</p><blockquote class="footnote"> <a name="FOOTNOTE-57" />[57]One
example is the lack of NFS over TCP support for your client or
server.</p> </blockquote>

<blockquote><pre class="code">% <tt class="userinput"><b>nfsstat -rc</b></tt> 
Client rpc:
Connection-oriented:
calls       badcalls    badxids     timeouts    newcreds    badverfs    
1753569     1412        3           64          0           0           
timers      cantconn    nomem       interrupts  
0           1317        0           18          
Connectionless:
calls       badcalls    retrans     badxids     timeouts    newcreds    
12252       41          334         5           166         0           
badverfs    timers      nomem       cantsend    
0           4321        0           206        </pre></blockquote>

When <em class="emphasis">timeouts</em> is high and
<em class="emphasis">badxid</em> is close to zero, it implies that the
network or one of the network interfaces on the client, server, or
any intermediate routing hardware is dropping packets. Some older
host Ethernet interfaces are tuned to handle page-sized packets and
do not reliably handle larger packets; similarly, many older Ethernet
bridges cannot forward long bursts of packets. Older routers or hosts
acting as IP routers may have limited forwarding capacity, so
reducing the number of packets sent for any request reduces the
probability that these routers will drop packets that build up behind
their network interfaces.
</p>

The NFS buffer size determines how many packets are required to send
a single, large <em class="emphasis">read</em> or
<em class="emphasis">write</em> request. The Solaris default buffer size
is 8KB for NFS Version 2 and 32KB for NFS Version 3. Linux<a href="#FOOTNOTE-58">[58]</a> uses a default buffer size of 1KB. The buffer size can be
negotiated down, at mount time, if the client determines that the
server prefers a smaller transfer size.
</p><blockquote class="footnote">
<a name="FOOTNOTE-58" />[58]This refers to Version 2.2.14-5 of the Linux kernel.</p>
</blockquote>

Compensating for unreliable networks involves changing the NFS buffer
size, controlled by the <em class="emphasis">rsize</em> and
<em class="emphasis">wsize</em> mount options. <em class="emphasis">rsize</em>
determines how many bytes are requested in each NFS read, and
<em class="emphasis">wsize</em> gauges the number of bytes sent in each
NFS write operation. Reducing <em class="emphasis">rsize</em> and
<em class="emphasis">wsize</em> eases the peak loads on the network by
sending shorter packet trains for each NFS request. By spacing the
requests out, and increasing the probability that the entire request
reaches the server or client intact on the first transmission, the
overall load on the network and server is smoothed out over time.
</p>

The read and write buffer sizes are specified in bytes. They are
generally made multiples of 512 bytes, based on the size of a disk
block. There is no requirement that either size be an integer
multiple of 512, although using an arbitrary size can make the disk
operations on the remote host less efficient. Write operations
performed on non-disk block aligned buffers require the NFS server to
read the block, modify the block, and rewrite it. The
read-modify-write cycle is invisible to the client, but adds to the
overhead of each <em class="emphasis">write( )</em> performed on the
server.
</p>

These values are used by the NFS async threads and are completely
independent of buffer sizes internal to any client-side processes. An
application that writes 400-byte buffers, writing to a filesystem
mounted with <em class="emphasis">wsize=4096</em>, does not cause an NFS
<em class="emphasis">write</em> request to be sent to the server until the
11th write is performed.
</p>

Here is an example of mounting an NFS filesystem with the read and
write buffer sizes reduced to 2048 bytes:
</p>

<blockquote><pre class="code"># <tt class="userinput"><b>mount -o rsize=2048,wsize=2048 wahoo:/export/home /mnt</b></tt></pre></blockquote>

Decreasing the NFS buffer size has
<a name="INDEX-2688" />
<a name="INDEX-2689" />the undesirable effect of increasing the
load on the server and sending more packets on the network to read or
write a given buffer. The size of the actual packets on the network
does not change, but the number of IP packets composing a single NFS
buffer decreases as the <em class="emphasis">rsize</em> and
<em class="emphasis">wsize</em> are decreased. For example, an 8KB NFS
buffer is divided into five IP packets of about 1500 bytes, and a
sixth packet with the remaining data bytes. If the write size is set
to 2048 bytes, only two IP packets are needed.
</p>

The problem lies in the number of packets required to transfer the
same amount of data. <a href="ch18_03.html#nfs2-CHP-18-TABLE-2">Table 18-2</a> shows the number of
IP packets required to copy a file for various NFS read buffer sizes.
</p>

<a name="nfs2-CHP-18-TABLE-2" /><h4 class="objtitle">Table 18-2. IP packets, RPC requests as function of NFS buffer size </h4><table border="1">






<tr>
<th>
File Size</p>
</th>
<th>
IP Packets/RPC Calls</p>
</th>
</tr>
<tr>
<th>

</th>
<th>
rsize</p>
</th>
<th>
rsize</p>
</th>
<th>
rsize</p>
</th>
<th>
rsize</p>
</th>
</tr>
<tr>
<th>
(kbytes)</p>
</th>
<th>
1024</p>
</th>
<th>
2048</p>
</th>
<th>
4096</p>
</th>
<th>
8192</p>
</th>
</tr>


<tr>
<td>
1</p>
</td>
<td>
1/1</p>
</td>
<td>
1/1</p>
</td>
<td>
1/1</p>
</td>
<td>
1/1</p>
</td>
</tr>
<tr>
<td>
2</p>
</td>
<td>
2/2</p>
</td>
<td>
2/1</p>
</td>
<td>
2/1</p>
</td>
<td>
2/1</p>
</td>
</tr>
<tr>
<td>
4</p>
</td>
<td>
4/4</p>
</td>
<td>
4/2</p>
</td>
<td>
3/1</p>
</td>
<td>
3/1</p>
</td>
</tr>
<tr>
<td>
8</p>
</td>
<td>
8/8</p>
</td>
<td>
8/4</p>
</td>
<td>
6/2</p>
</td>
<td>
6/1</p>
</td>
</tr>

</table><p>

As the file size increases, transfers with smaller NFS buffer sizes
send more IP packets to the server. The number of packets will be the
same for 4096- and 8192-byte buffers, but for file sizes over 4K,
setting <em class="emphasis">rsize=4096</em> always requires twice as many
RPC calls to the server. The increased network traffic adds to the
very problem for which the buffer size change was compensating, and
the additional RPC calls further load the server. Due to the
increased server load, it is sometimes necessary to increase the RPC
timeout parameter when decreasing NFS buffer sizes. Again, we
encourage you to use NFS over TCP when possible and avoid having to
worry about the NFS buffer <a name="INDEX-2690" />sizes. 
</p>



<hr width="684" align="left" />
<div class="navbar"><table width="684" border="0"><tr><td align="left" valign="top" width="228"><a href="ch18_02.html"><img alt="Previous" border="0" src="../gifs/txtpreva.gif" /></a></td><td align="center" valign="top" width="228"><a href="index.html"><img alt="Home" border="0" src="../gifs/txthome.gif" /></a></td><td align="right" valign="top" width="228"><a href="ch18_04.html"><img alt="Next" border="0" src="../gifs/txtnexta.gif" /></a></td></tr><tr><td align="left" valign="top" width="228">18.2. Soft mount issues</td><td align="center" valign="top" width="228"><a href="index/index.html"><img alt="Book Index" border="0" src="../gifs/index.gif" /></a></td><td align="right" valign="top" width="228">18.4. NFS over wide-area networks</td></tr></table><div>
<hr width="684" align="left" />

<img alt="Library Navigation Links" border="0" src="../gifs/navbar.gif" usemap="#library-map" />
<p><font size="-1"><a href="copyrght.html">Copyright &copy; 2002</a> O'Reilly &amp; Associates. All rights reserved.</font></p>

<map name="library-map"><area shape="rect" coords="1,0,84,90" href="../index.html" /><area shape="rect" coords="86,-7,176,90" href="../ssh/index.html" /><area shape="rect" coords="178,0,265,101" href="../tcp/index.html" /><area shape="rect" coords="266,0,333,90" href="index.html" /><area shape="rect" coords="334,-1,429,93" href="../snmp/index.html" /><area shape="rect" coords="431,0,529,116" href="../tshoot/index.html" /><area shape="rect" coords="534,0,594,104" href="../dns/index.html" /><area shape="rect" coords="595,1,704,108" href="../fire/index-2.html" /></map>

</body>
<!-- Mirrored from nnc3.com/mags/Networking2/nfs/ch18_03.htm by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 28 Jul 2017 17:56:44 GMT -->
</html>